{% extends 'base.html' %}

{% block title %}Account Settings{% endblock %}

{% block content %}
<style>
    /* Match Dashboard Styling */
    .settings-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
    }

    .card {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
        padding: 1.5rem;
    }

    .settings-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .settings-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .status-badge {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
    }

    .info-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #667eea;
    }

    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn-enhanced {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .btn-success-enhanced {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-success-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        color: white;
    }

    .btn-info-enhanced {
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .btn-info-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
        color: white;
    }

    .section-icon {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        padding: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }

    .quick-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>

<div class="container mt-4">
    <!-- Enhanced Header -->
    <div class="settings-header">
        <div class="text-center">
            <div class="section-icon">
                <i class="fas fa-cogs fa-2x"></i>
            </div>
            <h1 class="mb-2">Account Settings</h1>
            <p class="mb-0">Configure your water billing system preferences</p>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for message_data in messages %}
        <div class="alert alert-{{ message_data[0] if message_data is iterable and message_data|length > 1 else 'info' }} alert-dismissible fade show" role="alert">
            {{ message_data[1] if message_data is iterable and message_data|length > 1 else message_data }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Quick Configuration Status -->
    <div class="quick-stats">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-number">
                        {% if config %}
                            <i class="fas fa-check-circle"></i>
                        {% else %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% endif %}
                    </div>
                    <div class="stat-label">Rate Configuration</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-number">
                        {% if mpesa_config and mpesa_config.consumer_key %}
                            <i class="fas fa-check-circle"></i>
                        {% else %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% endif %}
                    </div>
                    <div class="stat-label">M-Pesa API</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-number">
                        {% if admin and admin.name %}
                            <i class="fas fa-check-circle"></i>
                        {% else %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% endif %}
                    </div>
                    <div class="stat-label">Profile Complete</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">

            <!-- 1. SMS & Rate Configuration -->
            <div class="card settings-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="section-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">Rate Configuration</h4>
                            <small>Set your water billing rates</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-section">
                        <h6><i class="fas fa-info-circle"></i> Configuration Status</h6>
                        {% if config %}
                            <p><strong>Last Updated:</strong> {{config.updated_at}}</p>
                            <p class="mb-0">
                                <strong>Status:</strong>
                                <span class="badge bg-success status-badge">Configured</span>
                            </p>
                        {% else %}
                            <p class="mb-0">
                                <strong>Status:</strong>
                                <span class="badge bg-warning status-badge">Rate Not Configured</span>
                            </p>
                        {% endif %}
                    </div>

                    <form method="POST" action="{{ url_for('sms_config') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="mb-4">
                            <label for="rate_per_unit" class="form-label">
                                <i class="fas fa-tint"></i> Rate Per Unit (KES)
                            </label>
                            <input type="number" step="0.01" min="0" class="form-control form-control-lg"
                                   id="rate_per_unit" name="rate_per_unit"
                                   value="{{config.rate_per_unit if config else rate_per_unit }}" required>
                            <div class="form-text">The amount charged per cubic meter of water consumed</div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="use_house_number_as_account"
                                       name="use_house_number_as_account"
                                       {% if config and config.use_house_number_as_account %}checked{% endif %}>
                                <label class="form-check-label" for="use_house_number_as_account">
                                    <strong>Use House Number as M-Pesa Account Reference</strong>
                                </label>
                            </div>
                            <div class="info-section mt-3">
                                <h6><i class="fas fa-mobile-alt"></i> How it works:</h6>
                                <p class="mb-2">When enabled, tenants can use their house number as the account name when paying via your M-Pesa PayBill/Till.</p>
                                <p class="mb-2"><strong>Example:</strong> Tenant in House A1 pays to your PayBill using "A1" as account name.</p>

                                <h6><i class="fas fa-cogs"></i> Setup Instructions:</h6>
                                <ol class="mb-0">
                                    <li>Configure this callback URL in your M-Pesa API:
                                        <code class="bg-light p-1 rounded">{{ request.url_root }}mpesa/paybill_callback</code>
                                    </li>
                                    <li>Ensure your PayBill/Till number matches the one in your profile</li>
                                    <li>Tenants should use their exact house number as the account name when paying</li>
                                </ol>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-enhanced">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                    </form>
                </div>
            </div>

            <!-- 2. M-Pesa API Configuration -->
            <div class="card settings-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="section-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">M-Pesa API Configuration</h4>
                            <small>Enable automatic payment tracking</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-section">
                        <h6><i class="fas fa-shield-alt"></i> M-Pesa API Setup</h6>
                        <p class="mb-2">To enable automatic payment tracking, you need to configure your M-Pesa API credentials.</p>
                        <p class="mb-0">
                            <strong>Status:</strong>
                            {% if mpesa_config and mpesa_config.consumer_key %}
                                <span class="badge bg-success status-badge">Configured</span>
                            {% else %}
                                <span class="badge bg-warning status-badge text-dark">Not Configured</span>
                            {% endif %}
                        </p>
                    </div>

                    <form method="POST" action="{{ url_for('save_mpesa_config') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="consumer_key" class="form-label">
                                        <i class="fas fa-key"></i> Consumer Key
                                    </label>
                                    <input type="text" class="form-control" id="consumer_key" name="consumer_key"
                                           value="{{ mpesa_config.consumer_key if mpesa_config else '' }}"
                                           placeholder="Your Safaricom App Consumer Key">
                                    <div class="form-text">Get this from your Safaricom Developer Portal</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="consumer_secret" class="form-label">
                                        <i class="fas fa-lock"></i> Consumer Secret
                                    </label>
                                    <input type="password" class="form-control" id="consumer_secret" name="consumer_secret"
                                           value="{{ mpesa_config.consumer_secret if mpesa_config else '' }}"
                                           placeholder="Your Safaricom App Consumer Secret">
                                    <div class="form-text">Keep this secret and secure</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="shortcode" class="form-label">
                                        <i class="fas fa-hashtag"></i> Business Shortcode
                                    </label>
                                    <input type="text" class="form-control" id="shortcode" name="shortcode"
                                           value="{{ mpesa_config.shortcode if mpesa_config else '' }}"
                                           placeholder="e.g., 174379">
                                    <div class="form-text">Your M-Pesa PayBill or Till Number</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="passkey" class="form-label">
                                        <i class="fas fa-fingerprint"></i> Passkey
                                    </label>
                                    <input type="password" class="form-control" id="passkey" name="passkey"
                                           value="{{ mpesa_config.passkey if mpesa_config else '' }}"
                                           placeholder="Your M-Pesa Passkey">
                                    <div class="form-text">Provided by Safaricom for STK Push</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="environment" class="form-label">
                                        <i class="fas fa-server"></i> Environment
                                    </label>
                                    <select class="form-control" id="environment" name="environment">
                                        <option value="sandbox" {% if not mpesa_config or mpesa_config.environment == 'sandbox' %}selected{% endif %}>
                                            Sandbox (Testing)
                                        </option>
                                        <option value="production" {% if mpesa_config and mpesa_config.environment == 'production' %}selected{% endif %}>
                                            Production (Live)
                                        </option>
                                    </select>
                                    <div class="form-text">Use Sandbox for testing, Production for live payments</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="callback_url" class="form-label">
                                        <i class="fas fa-link"></i> Callback URL
                                    </label>
                                    <input type="text" class="form-control" id="callback_url" name="callback_url" readonly
                                           value="{{ request.url_root }}mpesa/paybill_callback">
                                    <div class="form-text">Configure this URL in your M-Pesa API settings</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success-enhanced">
                                <i class="fas fa-save"></i> Save M-Pesa Configuration
                            </button>
                            <button type="button" class="btn btn-info-enhanced" data-bs-toggle="modal" data-bs-target="#mpesaGuideModal">
                                <i class="fas fa-question-circle"></i> Setup Guide
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 3. User Profile Settings -->
            <div class="card settings-card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="section-icon">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">Account Information</h4>
                            <small>Manage your profile and payment details</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_profile') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">
                                        <i class="fas fa-user"></i> Full Name
                                    </label>
                                    <input type="text" class="form-control" id="name" name="name"
                                           value="{{ admin.name if admin else '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone" class="form-label">
                                        <i class="fas fa-phone"></i> Phone Number
                                    </label>
                                    <input type="number" class="form-control" id="phone" name="phone"
                                           value="{{ admin.phone if admin else '' }}" required>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic payment method field based on admin's payment_method -->
                        {% if admin and admin.payment_method == 'paybill' %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="business_number" class="form-label">
                                        <i class="fas fa-building"></i> PayBill Business Number
                                    </label>
                                    <input type="text" class="form-control" id="business_number" name="business_number"
                                           value="{{ admin.business_number if admin else '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="account_name" class="form-label">
                                        <i class="fas fa-tag"></i> Account Name
                                    </label>
                                    <input type="text" class="form-control" id="account_name" name="account_name"
                                           value="{{ admin.account_name if admin else '' }}" required>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="mb-3">
                            <label for="till" class="form-label">
                                <i class="fas fa-cash-register"></i> Till Number
                            </label>
                            <input type="number" class="form-control" id="till" name="till" maxlength="6"
                                   value="{{ admin.till if admin else '' }}" required>
                        </div>
                        {% endif %}

                        <button type="submit" class="btn btn-info-enhanced">
                            <i class="fas fa-user-edit"></i> Update Profile
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Include the existing M-Pesa Guide Modal here -->
<!-- Modal content remains the same as in original file -->

{% endblock %}