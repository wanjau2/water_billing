<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>{{ tenant.name }} - Water Portal</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
        }

        /* Mobile-first responsive design */
        .mobile-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #6c757d 100%);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mobile-header h1 {
            font-size: 1.25rem;
            margin: 0;
            font-weight: 600;
        }

        .mobile-header .subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Quick Stats Cards */
        .quick-stats {
            padding: 1rem;
            margin-top: -1rem;
            position: relative;
            z-index: 100;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 1rem;
            border: none;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin: 0;
        }

        /* Action Buttons */
        .action-buttons {
            padding: 0 1rem 1rem;
        }

        .action-btn {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1rem;
            text-decoration: none;
            color: #495057;
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .action-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            color: #495057;
            text-decoration: none;
        }

        .action-btn i {
            font-size: 1.25rem;
            margin-right: 1rem;
            width: 24px;
            text-align: center;
        }

        .action-btn .action-title {
            font-weight: 600;
            margin: 0;
        }

        .action-btn .action-desc {
            font-size: 0.875rem;
            color: #6c757d;
            margin: 0;
        }

        /* Payment Status Badges */
        .status-paid { color: var(--success-color); }
        .status-partial { color: var(--warning-color); }
        .status-unpaid { color: var(--danger-color); }

        /* Usage Chart Container */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dee2e6;
            padding: 0.75rem;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            color: #6c757d;
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 8px;
            min-width: 60px;
            transition: all 0.2s;
        }

        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-item:hover {
            color: var(--primary-color);
            text-decoration: none;
        }

        .nav-item i {
            display: block;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .nav-item span {
            font-size: 0.75rem;
        }

        /* Content sections */
        .content-section {
            display: none;
            padding-bottom: 100px; /* Space for bottom nav */
        }

        .content-section.active {
            display: block;
        }

        /* Bills list */
        .bill-item {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin: 0.5rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .bill-date {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .bill-amount {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Maintenance form */
        .maintenance-form {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Responsive improvements */
        @media (max-width: 576px) {
            .mobile-header {
                padding: 0.75rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            .action-btn {
                padding: 0.75rem;
            }
        }

        /* Loading states */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error messages */
        .message {
            margin: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <h1><i class="fas fa-tint"></i> {{ tenant.name }}</h1>
        <p class="subtitle">House {{ tenant.house_number }} • Water Portal</p>
    </div>

    <!-- Quick Stats Section -->
    <div id="overview-section" class="content-section active">
        <div class="quick-stats">
            <div class="row g-3">
                <div class="col-4">
                    <div class="stat-card">
                        <p class="stat-value text-primary" id="current-usage">-</p>
                        <p class="stat-label">This Month</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card">
                        <p class="stat-value" id="outstanding-amount">KES 0</p>
                        <p class="stat-label">Outstanding</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card">
                        <p class="stat-value text-success" id="avg-usage">-</p>
                        <p class="stat-label">Avg/Month</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="action-buttons">
            <a href="#" class="action-btn" onclick="showSection('bills-section')">
                <i class="fas fa-file-invoice text-primary"></i>
                <div>
                    <p class="action-title">View Bills</p>
                    <p class="action-desc">See payment history & outstanding bills</p>
                </div>
            </a>

            <a href="#" class="action-btn" onclick="showSection('payment-section')">
                <i class="fas fa-credit-card text-success"></i>
                <div>
                    <p class="action-title">Make Payment</p>
                    <p class="action-desc">Pay via M-Pesa, Cash, or Bank Transfer</p>
                </div>
            </a>

            <a href="#" class="action-btn" onclick="showSection('usage-section')">
                <i class="fas fa-chart-line text-info"></i>
                <div>
                    <p class="action-title">Usage Analytics</p>
                    <p class="action-desc">Track your water consumption trends</p>
                </div>
            </a>

            <a href="#" class="action-btn" onclick="showSection('maintenance-section')">
                <i class="fas fa-tools text-warning"></i>
                <div>
                    <p class="action-title">Report Issue</p>
                    <p class="action-desc">Submit maintenance requests</p>
                </div>
            </a>
        </div>
    </div>

    <!-- Bills Section -->
    <div id="bills-section" class="content-section">
        <div class="d-flex justify-content-between align-items-center p-3">
            <h5><i class="fas fa-file-invoice"></i> My Bills</h5>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshBills()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div id="bills-list">
            {% if readings %}
                {% for reading in readings %}
                <div class="bill-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="bill-date">{{ reading.date_recorded.strftime('%b %d, %Y') if reading.date_recorded else 'N/A' }}</div>
                            <div class="fw-bold">{{ reading.usage }} m³ used</div>
                            <div class="small text-muted">
                                Previous: {{ reading.previous_reading }} → Current: {{ reading.current_reading }}
                            </div>
                            {% if reading.payment_status != 'paid' %}
                                <div class="small text-info mt-1" id="fine-info-{{ reading._id }}">
                                    <i class="fas fa-info-circle"></i> Fine info loading...
                                </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <div class="bill-amount">KES {{ "%.2f"|format(reading.bill_amount) }}</div>
                            {% if reading.payment_status != 'paid' %}
                                <div class="small text-warning" id="total-due-{{ reading._id }}">
                                    <i class="fas fa-calculator"></i> Calculating total...
                                </div>
                            {% endif %}
                            <div class="small status-{{ reading.payment_status }}">
                                {% if reading.payment_status == 'paid' %}
                                    <i class="fas fa-check-circle"></i> Paid
                                {% elif reading.payment_status == 'partial' %}
                                    <i class="fas fa-clock"></i> Partial
                                {% else %}
                                    <i class="fas fa-exclamation-circle"></i> Unpaid
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>No bills found</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Payment Section -->
    <div id="payment-section" class="content-section">
        <div class="maintenance-form">
            <h5><i class="fas fa-credit-card text-success"></i> Make Payment</h5>
            <p class="text-muted">Choose your preferred payment method:</p>

            <!-- Payment Methods -->
            <div class="mb-4">
                <h6>Available Payment Methods:</h6>

                <!-- M-Pesa Payment -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-mobile-alt text-success"></i> M-Pesa Payment</h6>
                        <p class="card-text small">Pay using M-Pesa STK Push</p>
                        <div class="mb-3">
                            <label class="form-label">Amount (KES)</label>
                            <input type="number" class="form-control" id="mpesa-amount" placeholder="Enter amount">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="mpesa-phone" placeholder="0700000000" value="{{ tenant.phone or '' }}">
                        </div>
                        <button class="btn btn-success w-100" onclick="initiateM-PesaPayment()">
                            <i class="fas fa-mobile-alt"></i> Pay with M-Pesa
                        </button>
                    </div>
                </div>

                <!-- Manual Payment Instructions -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-university text-primary"></i> Bank Transfer</h6>
                        <p class="card-text small">Bank account details for manual payment</p>
                        <div class="alert alert-info">
                            <strong>Account Details:</strong><br>
                            <span id="bank-details">Contact property manager for account details</span>
                        </div>
                    </div>
                </div>

                <!-- Cash Payment -->
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-money-bill text-warning"></i> Cash Payment</h6>
                        <p class="card-text small">Pay directly to property manager</p>
                        <div class="alert alert-warning">
                            <strong>Property Manager:</strong><br>
                            {{ admin.name if admin else 'N/A' }}<br>
                            <i class="fas fa-phone"></i> {{ admin.phone if admin else 'N/A' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Analytics Section -->
    <div id="usage-section" class="content-section">
        <div class="chart-container">
            <h5><i class="fas fa-chart-line text-info"></i> Usage Trends</h5>
            <canvas id="usageChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-container">
            <h6>Usage Statistics</h6>
            <div class="row g-3">
                <div class="col-6">
                    <div class="text-center">
                        <div class="h4 text-primary" id="total-usage">0 m³</div>
                        <div class="small text-muted">Total Usage</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center">
                        <div class="h4 text-success" id="avg-monthly">0 m³</div>
                        <div class="small text-muted">Monthly Average</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Section -->
    <div id="maintenance-section" class="content-section">
        <div class="maintenance-form">
            <h5><i class="fas fa-tools text-warning"></i> Report Maintenance Issue</h5>
            <form id="maintenance-form">
                <div class="mb-3">
                    <label for="issue-type" class="form-label">Issue Type</label>
                    <select class="form-select" id="issue-type" required>
                        <option value="">Select issue type</option>
                        <option value="plumbing">Plumbing (Leaks, Blockages)</option>
                        <option value="meter">Water Meter Issues</option>
                        <option value="pressure">Low Water Pressure</option>
                        <option value="quality">Water Quality Issues</option>
                        <option value="billing">Billing Disputes</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="issue-priority" class="form-label">Priority</label>
                    <select class="form-select" id="issue-priority" required>
                        <option value="low">Low - Can wait a few days</option>
                        <option value="medium">Medium - Within 24 hours</option>
                        <option value="high">High - Urgent attention needed</option>
                        <option value="emergency">Emergency - Immediate action required</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="issue-description" class="form-label">Description</label>
                    <textarea class="form-control" id="issue-description" rows="4"
                              placeholder="Please describe the issue in detail..." required></textarea>
                </div>

                <div class="mb-3">
                    <label for="tenant-phone" class="form-label">Your Phone Number</label>
                    <input type="tel" class="form-control" id="tenant-phone"
                           value="{{ tenant.phone or '' }}" required>
                </div>

                <button type="submit" class="btn btn-warning w-100">
                    <i class="fas fa-paper-plane"></i> Submit Request
                </button>
            </form>
        </div>

        <!-- Recent Requests -->
        <div class="maintenance-form">
            <h6>Recent Requests</h6>
            <div id="recent-requests">
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                    <p>No recent requests</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="#" class="nav-item active" onclick="showSection('overview-section')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" onclick="showSection('bills-section')">
            <i class="fas fa-file-invoice"></i>
            <span>Bills</span>
        </a>
        <a href="#" class="nav-item" onclick="showSection('payment-section')">
            <i class="fas fa-credit-card"></i>
            <span>Pay</span>
        </a>
        <a href="#" class="nav-item" onclick="showSection('usage-section')">
            <i class="fas fa-chart-line"></i>
            <span>Usage</span>
        </a>
        <a href="#" class="nav-item" onclick="showSection('maintenance-section')">
            <i class="fas fa-tools"></i>
            <span>Support</span>
        </a>
    </div>

    <script>
        // Global variables
        let currentSection = 'overview-section';
        let usageChart = null;

        // Navigation functionality
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active to corresponding nav item
            const navIndex = {
                'overview-section': 0,
                'bills-section': 1,
                'payment-section': 2,
                'usage-section': 3,
                'maintenance-section': 4
            };

            document.querySelectorAll('.nav-item')[navIndex[sectionId]].classList.add('active');

            currentSection = sectionId;

            // Load section-specific data
            if (sectionId === 'usage-section' && !usageChart) {
                loadUsageChart();
            }
        }

        // Load usage chart
        function loadUsageChart() {
            const ctx = document.getElementById('usageChart').getContext('2d');

            // Sample data - replace with actual data from server
            const usageData = {{ readings | map(attribute='usage') | list | tojson }};
            const dateLabels = {{ readings | map(attribute='date_recorded') | map('string') | list | tojson }};

            usageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dateLabels.map(date => new Date(date).toLocaleDateString()),
                    datasets: [{
                        label: 'Water Usage (m³)',
                        data: usageData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Usage (m³)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Update statistics
            updateUsageStats();
        }

        // Update usage statistics
        function updateUsageStats() {
            const readings = {{ readings | tojson }};

            if (readings && readings.length > 0) {
                const totalUsage = readings.reduce((sum, reading) => sum + (reading.usage || 0), 0);
                const avgUsage = totalUsage / readings.length;
                const currentMonthUsage = readings[0] ? readings[0].usage : 0;
                const outstandingAmount = readings.reduce((sum, reading) => {
                    return sum + (reading.outstanding || 0);
                }, 0);

                // Update overview stats
                document.getElementById('current-usage').textContent = currentMonthUsage + ' m³';
                document.getElementById('outstanding-amount').textContent = 'KES ' + outstandingAmount.toFixed(2);
                document.getElementById('avg-usage').textContent = avgUsage.toFixed(1) + ' m³';

                // Update usage section stats
                document.getElementById('total-usage').textContent = totalUsage.toFixed(1) + ' m³';
                document.getElementById('avg-monthly').textContent = avgUsage.toFixed(1) + ' m³';

                // Update outstanding amount color
                const outstandingEl = document.getElementById('outstanding-amount');
                if (outstandingAmount > 0) {
                    outstandingEl.className = 'stat-value text-danger';
                } else {
                    outstandingEl.className = 'stat-value text-success';
                }
            }
        }

        // Maintenance form submission
        document.getElementById('maintenance-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = {
                issue_type: document.getElementById('issue-type').value,
                priority: document.getElementById('issue-priority').value,
                description: document.getElementById('issue-description').value,
                phone: document.getElementById('tenant-phone').value
            };

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;

            // Submit to server (implement API endpoint)
            fetch('/api/maintenance_request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Request submitted successfully! We will contact you soon.', 'success');
                    document.getElementById('maintenance-form').reset();
                } else {
                    showMessage('Error submitting request. Please try again.', 'error');
                }
            })
            .catch(error => {
                showMessage('Error submitting request. Please try again.', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });

        // M-Pesa payment functionality
        function initiateM-PesaPayment() {
            const amount = document.getElementById('mpesa-amount').value;
            const phone = document.getElementById('mpesa-phone').value;

            if (!amount || !phone) {
                showMessage('Please enter amount and phone number', 'error');
                return;
            }

            // Implement M-Pesa payment logic
            showMessage('M-Pesa payment functionality coming soon!', 'success');
        }

        // Show message function
        function showMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${text}`;

            // Insert at top of current section
            const currentSectionEl = document.getElementById(currentSection);
            currentSectionEl.insertBefore(messageDiv, currentSectionEl.firstChild);

            // Remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Refresh bills
        function refreshBills() {
            showMessage('Bills refreshed', 'success');
        }

        // Calculate and display fine information for bills
        function calculateFineInfo() {
            {% for reading in readings %}
                {% if reading.payment_status != 'paid' %}
                    // Calculate fine for unpaid/partial bills
                    const billDate = new Date('{{ reading.date_recorded.strftime('%Y-%m-%d') if reading.date_recorded else datetime.now().strftime('%Y-%m-%d') }}');
                    const dueDate = new Date(billDate.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days from bill date
                    const currentDate = new Date();
                    const daysOverdue = Math.floor((currentDate - dueDate) / (24 * 60 * 60 * 1000));
                    const gracePeriod = 7; // Default grace period

                    const billAmount = {{ reading.bill_amount }};
                    const amountPaid = {{ reading.amount_paid or 0 }};
                    const outstanding = billAmount - amountPaid;

                    let fineAmount = 0;
                    let fineInfo = '';

                    if (daysOverdue > gracePeriod && outstanding > 0) {
                        // Calculate 5% fine (this should match backend calculation)
                        fineAmount = outstanding * 0.05; // 5% default
                        const totalDue = outstanding + fineAmount;

                        fineInfo = `Late fee: KES ${fineAmount.toFixed(2)} (${daysOverdue - gracePeriod} days overdue)`;

                        // Update fine info display
                        const fineInfoElement = document.getElementById('fine-info-{{ reading._id }}');
                        const totalDueElement = document.getElementById('total-due-{{ reading._id }}');

                        if (fineInfoElement) {
                            fineInfoElement.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> ${fineInfo}`;
                            fineInfoElement.classList.remove('text-info');
                            fineInfoElement.classList.add('text-warning');
                        }

                        if (totalDueElement) {
                            totalDueElement.innerHTML = `<strong>Total Due: KES ${totalDue.toFixed(2)}</strong>`;
                            totalDueElement.classList.remove('text-warning');
                            totalDueElement.classList.add('text-danger');
                        }
                    } else {
                        // No fine applicable
                        const fineInfoElement = document.getElementById('fine-info-{{ reading._id }}');
                        const totalDueElement = document.getElementById('total-due-{{ reading._id }}');

                        if (daysOverdue <= 0) {
                            fineInfo = `Due in ${Math.abs(daysOverdue)} days`;
                        } else if (daysOverdue <= gracePeriod) {
                            fineInfo = `${gracePeriod - daysOverdue} days until late fee`;
                        }

                        if (fineInfoElement) {
                            fineInfoElement.innerHTML = `<i class="fas fa-clock text-info"></i> ${fineInfo}`;
                        }

                        if (totalDueElement) {
                            totalDueElement.innerHTML = `Amount Due: KES ${outstanding.toFixed(2)}`;
                            totalDueElement.classList.remove('text-warning');
                            totalDueElement.classList.add('text-info');
                        }
                    }
                {% endif %}
            {% endfor %}
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateUsageStats();
            calculateFineInfo();
        });

        // Add touch/swipe functionality for mobile
        let startX = 0;
        let startY = 0;

        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            if (!startX || !startY) return;

            let endX = e.changedTouches[0].clientX;
            let endY = e.changedTouches[0].clientY;

            let diffX = startX - endX;
            let diffY = startY - endY;

            // Only handle horizontal swipes
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                const sections = ['overview-section', 'bills-section', 'payment-section', 'usage-section', 'maintenance-section'];
                const currentIndex = sections.indexOf(currentSection);

                if (diffX > 0 && currentIndex < sections.length - 1) {
                    // Swipe left - next section
                    showSection(sections[currentIndex + 1]);
                } else if (diffX < 0 && currentIndex > 0) {
                    // Swipe right - previous section
                    showSection(sections[currentIndex - 1]);
                }
            }

            startX = 0;
            startY = 0;
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>