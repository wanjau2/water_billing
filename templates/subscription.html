{% extends "base.html" %}
{% block title %}Subscription Management{% endblock %}

{% block styles %}
<style>
    .subscription-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }

    .subscription-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .subscription-card .card-header {
        padding: 1.5rem;
        border-bottom: 2px solid rgba(0, 0, 0, 0.1);
    }

    .subscription-card.current-plan {
        border: 3px solid #0d6efd;
        box-shadow: 0 5px 15px rgba(13, 110, 253, 0.2);
    }

    .subscription-card .card-body {
        padding: 1.5rem;
    }

    .price-display {
        font-size: 2.5rem;
        font-weight: 700;
        color: #0d6efd;
        line-height: 1;
        margin: 1rem 0;
    }

    .price-period {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 400;
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 1.5rem 0;
    }

    .feature-list li {
        padding: 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .feature-list li i {
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .btn-subscription {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }

    .btn-subscription:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-upgrade {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }

    .btn-upgrade:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
    }

    .btn-change-plan {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: white;
    }

    .btn-change-plan:hover {
        background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        color: white;
    }

    .btn-activate {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        color: white;
    }

    .btn-activate:hover {
        background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        color: white;
    }

    .current-plan-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .progress-bar {
        transition: width 0.6s ease;
    }

    .annual-badge {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .status-card .card-header {
        background: transparent;
        border: none;
    }

    .status-card .card-body {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Subscription Management</h1>

    <!-- Payment Provider Badge -->
    {% if payment_provider == 'paystack' %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-credit-card-2-front"></i>
        <strong>Secure Payments by Paystack</strong> - Accept M-Pesa, Visa, Mastercard, and more
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% elif payment_provider == 'both' %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-wallet2"></i>
        <strong>Multiple Payment Options</strong> - Pay via Paystack (Cards/M-Pesa) or M-Pesa Direct
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <!-- Current Plan -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>Current Plan: {{ current_tier.name }} 
                        <span class="badge bg-light text-dark">
                            {{ subscription_type|title }}
                        </span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Status:</strong>
                                <span class="badge {% if subscription_status == 'active' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ subscription_status|upper }}
                                </span>
                            </p>
                            <p><strong>Subscription Type:</strong>
                                <span class="badge {% if subscription_type == 'annual' %}bg-info{% else %}bg-primary{% endif %}">
                                    {{ subscription_type|title }}
                                </span>
                            </p>
                            {% if subscription_end_date %}
                            <p><strong>Expires:</strong>
                                {{ subscription_end_date.strftime('%B %d, %Y') }}
                                {% if days_remaining is not none %}
                                    {% if days_remaining > 0 %}
                                    <br><small class="text-muted">({{ days_remaining }} days remaining)</small>
                                    {% elif days_remaining == 0 %}
                                    <br><small class="text-warning">(Expires today!)</small>
                                    {% else %}
                                    <br><small class="text-danger">(Expired {{ -days_remaining }} days ago)</small>
                                    {% endif %}
                                {% endif %}
                            </p>
                            {% else %}
                            <p><strong>Expires:</strong>
                                <span class="text-muted">Not set</span>
                                <br>
                                <a href="{{ url_for('fix_subscription_dates') }}" class="btn btn-sm btn-warning mt-2">
                                    <i class="fas fa-wrench"></i> Fix Subscription Dates
                                </a>
                            </p>
                            {% endif %}
                            <p><strong>Auto-Renew:</strong>
                                <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input" type="checkbox" id="autoRenewSwitch"
                                           {% if auto_renew %}checked{% endif %}>
                                </div>
                                <small class="text-muted d-block">Automatically renew when subscription expires</small>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h5>Usage:</h5>
                            <p>Tenants: {{ tenant_count }} / 
                                {% if current_tier.max_tenants == -1 %}
                                Unlimited
                                {% else %}
                                {{ current_tier.max_tenants }}
                                {% endif %}
                            </p>
                            
                            {% if current_tier.max_tenants != -1 %}
                            <div class="progress mb-2">
                                <div class="progress-bar {% if tenant_count >= current_tier.max_tenants %}bg-danger{% endif %}" 
                                     role="progressbar" 
                                     data-width="{{ (tenant_count / current_tier.max_tenants * 100)|int }}">
                                    {{ (tenant_count / current_tier.max_tenants * 100)|int }}%
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <h5>Current Features:</h5>
                            <ul class="list-unstyled">
                                {% for feature in current_tier.features[:3] %}
                                <li><i class="bi bi-check-circle text-success"></i> {{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Available Plans -->
    <h2 class="mb-3">Available Plans</h2>
    <div class="row">
        {% for tier_key, tier in subscription_tiers.items() %}
        <div class="col-md mb-4">
            <div class="card h-100 subscription-card {% if tier_key == current_subscription_tier %}current-plan{% endif %}">
                <div class="card-header text-center {% if tier_key == current_subscription_tier %}bg-primary text-white{% endif %}">
                    <h5 class="mb-0">{{ tier.name }}</h5>
                    {% if tier_key == current_subscription_tier %}
                    <span class="current-plan-badge">Current Plan</span>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="text-center mb-3">
                        <div class="price-display">
                            {% if tier.monthly_price == 0 %}
                            Free
                            {% else %}
                            KES {{ "{:,}".format(tier.monthly_price) }}
                            {% endif %}
                        </div>
                        <div class="price-period">per month</div>

                        {% if tier.annual_price > 0 %}
                        <div class="mt-2">
                            <span class="annual-badge">Annual: KES {{ "{:,}".format(tier.annual_price) }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <ul class="feature-list flex-grow-1">
                        {% for feature in tier.features %}
                        <li>
                            <i class="bi bi-check-circle text-success"></i>
                            <span>{{ feature }}</span>
                        </li>
                        {% endfor %}
                    </ul>

                    {% if tier_key != current_subscription_tier or subscription_type == 'monthly' %}
                    <div class="mt-auto">
                        {% if tier.monthly_price == 0 %}
                        <form method="POST" action="{{ url_for('initiate_subscription_payment') }}" class="subscription-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tier" value="{{ tier_key }}">
                            <input type="hidden" name="payment_type" value="monthly">
                            <button type="submit" class="btn btn-subscription btn-activate w-100">
                                {% if tier.monthly_price < current_tier.monthly_price %}Switch to Free{% else %}Activate{% endif %}
                            </button>
                        </form>
                        {% else %}
                            <!-- Paystack Payment Button (Primary) -->
                            {% if payment_provider in ['paystack', 'both'] %}
                            <button type="button" class="btn btn-subscription {% if tier.monthly_price > current_tier.monthly_price %}btn-upgrade{% else %}btn-change-plan{% endif %} w-100 mb-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#paystackModal{{ tier_key }}">
                                <i class="bi bi-credit-card"></i>
                                {% if tier.monthly_price > current_tier.monthly_price %}Upgrade{% else %}Change Plan{% endif %} with Paystack
                            </button>
                            {% endif %}

                            <!-- M-Pesa Direct Button (Secondary or Primary if no Paystack) -->
                            {% if payment_provider in ['mpesa', 'both'] %}
                            <button type="button" class="btn btn-subscription {% if payment_provider == 'both' %}btn-outline-primary{% else %}{% if tier.monthly_price > current_tier.monthly_price %}btn-upgrade{% else %}btn-change-plan{% endif %}{% endif %} w-100"
                                    data-bs-toggle="modal"
                                    data-bs-target="#paymentModal{{ tier_key }}">
                                <i class="bi bi-phone"></i>
                                {% if payment_provider == 'both' %}Pay with M-Pesa Direct{% else %}{% if tier.monthly_price > current_tier.monthly_price %}Upgrade{% else %}Change Plan{% endif %}{% endif %}
                            </button>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Paystack Payment Modal -->
        {% if tier.monthly_price > 0 and payment_provider in ['paystack', 'both'] %}
        <div class="modal fade" id="paystackModal{{ tier_key }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-credit-card-2-front"></i>
                            Subscribe to {{ tier.name }} - Paystack
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="{{ url_for('paystack_initiate_subscription_payment') }}" id="paystackForm{{ tier_key }}" target="_top">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="tier" value="{{ tier_key }}">

                            <div class="mb-3">
                                <label class="form-label">Select Payment Type</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio"
                                           name="payment_type" value="monthly"
                                           id="paystack_monthly_{{ tier_key }}" checked>
                                    <label class="form-check-label" for="paystack_monthly_{{ tier_key }}">
                                        <strong>Monthly - KES {{ "{:,}".format(tier.monthly_price) }}</strong>
                                        <br><small class="text-muted">Renews every month</small>
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio"
                                           name="payment_type" value="annual"
                                           id="paystack_annual_{{ tier_key }}">
                                    <label class="form-check-label" for="paystack_annual_{{ tier_key }}">
                                        <strong>Annual - KES {{ "{:,}".format(tier.annual_price) }}</strong>
                                        <span class="badge bg-success">Save {{ ((tier.monthly_price * 12 - tier.annual_price) / (tier.monthly_price * 12) * 100)|int }}%</span>
                                        <br><small class="text-muted">Renews every year</small>
                                    </label>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <strong><i class="bi bi-info-circle"></i> Payment Methods:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>M-Pesa Mobile Money</li>
                                    <li>Visa & Mastercard</li>
                                    <li>Bank Transfer</li>
                                </ul>
                            </div>

                            <div class="alert alert-success">
                                <small>
                                    <strong><i class="bi bi-shield-check"></i> Secure Payment:</strong>
                                    You'll be redirected to Paystack's secure payment page.
                                    Transaction fee: <strong>1.5%</strong>
                                </small>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-right-circle"></i>
                                Proceed to Secure Payment
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- M-Pesa Direct Payment Modal -->
        {% if tier.monthly_price > 0 and payment_provider in ['mpesa', 'both'] %}
        <div class="modal fade" id="paymentModal{{ tier_key }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Subscribe to {{ tier.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form class="subscription-form" data-tier="{{ tier_key }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <label class="form-label">Select Payment Type</label>
                                <div class="form-check">
                                    <input class="form-check-input payment-type-radio" type="radio" 
                                           name="payment_type_{{ tier_key }}" value="monthly" 
                                           id="monthly_{{ tier_key }}" checked>
                                    <label class="form-check-label" for="monthly_{{ tier_key }}">
                                        Monthly - KES {{ "{:,}".format(tier.monthly_price) }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input payment-type-radio" type="radio" 
                                           name="payment_type_{{ tier_key }}" value="annual"
                                           id="annual_{{ tier_key }}">
                                    <label class="form-check-label" for="annual_{{ tier_key }}">
                                        Annual - KES {{ "{:,}".format(tier.annual_price) }}
                                        <span class="badge bg-success">Save {{ ((tier.monthly_price * 12 - tier.annual_price) / (tier.monthly_price * 12) * 100)|int }}%</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="phone_{{ tier_key }}" class="form-label">M-Pesa Phone Number</label>
                                <input type="tel" class="form-control" id="phone_{{ tier_key }}" 
                                       name="phone_number" value="{{ admin_phone }}" required>
                                <small class="text-muted">You'll receive an M-Pesa prompt on this number</small>
                            </div>
                            
                            <div class="alert alert-info">
                                <small>
                                    <strong>Note:</strong> You'll receive an M-Pesa STK push notification. 
                                    Enter your M-Pesa PIN to complete the payment.
                                </small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary proceed-payment" 
                                data-tier="{{ tier_key }}">
                            Proceed to Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- Payment History -->
    {% if payment_history %}
    <div class="row mt-4">
        <div class="col-md-12">
            <h3>Recent Payments</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Plan</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Receipt</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payment_history %}
                        <tr>
                            <td>{{ payment.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ payment.tier|title }}</td>
                            <td>{{ payment.payment_type|title }}</td>
                            <td>KES {{ "{:,}".format(payment.amount) }}</td>
                            <td>
                                <span class="badge bg-{% if payment.status == 'completed' %}success{% elif payment.status == 'pending' %}warning{% else %}danger{% endif %}">
                                    {{ payment.status|title }}
                                </span>
                            </td>
                            <td>{{ payment.receipt_number if payment.receipt_number else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Payment Progress Modal -->
<div class="modal fade" id="paymentProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing Payment...</h5>
                <p class="text-muted">Please check your phone for the M-Pesa prompt and enter your PIN.</p>
                <p class="text-muted">This may take a few seconds...</p>
            </div>
        </div>
    </div>
</div>

<!-- External subscription JavaScript -->
<script src="{{ url_for('static', filename='js/subscription.js') }}"></script>
{% endblock %}