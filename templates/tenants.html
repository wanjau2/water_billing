{% extends "base.html" %}

{% block title %}Water Billing - Tenant Management {% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #0066cc;
        --primary-light: #3385d6;
        --primary-dark: #004c99;
        --secondary-color: #6c757d;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
        --text-dark: #212529;
        --text-muted: #6c757d;
        --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        --hover-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        --border-radius: 8px;
        --transition: all 0.3s ease;
    }

    body {
        background-color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-dark);
        line-height: 1.6;
    }

    .search-section {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        transition: var(--transition);
    }

    .search-section:hover {
        box-shadow: var(--hover-shadow);
    }


    .tenant-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
    }

    .tenant-link:hover {
        color: var(--primary-dark);
        text-decoration: underline;
    }

    .card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        transition: var(--transition);
        overflow: hidden;
    }

    .card:hover {
        box-shadow: var(--hover-shadow);
        transform: translateY(-2px);
    }

    .card-header {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .card-header i {
        margin-right: 0.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .table-responsive {
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    .table {
        margin-bottom: 0;
        background: white;
    }

    .table thead th {
        background-color: var(--light-bg);
        border: none;
        padding: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table tbody tr {
        transition: var(--transition);
        border: none;
    }

    .table tbody tr:hover {
        background-color: rgba(0, 102, 204, 0.05);
    }

    .table tbody td {
        padding: 1rem;
        border: none;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
    }

    .table-striped > tbody > tr:nth-of-type(odd) > td {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .excel-preview {
        background-color: var(--light-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .excel-preview table {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        width: 100%;
        margin-bottom: 0;
    }

    .excel-preview th {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem;
        font-weight: 500;
    }

    .excel-preview td {
        padding: 0.75rem;
        border: none;
        border-bottom: 1px solid var(--border-color);
    }

    .form-control {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 0.75rem 1rem;
        transition: var(--transition);
        background: white;
        font-size: 0.95rem;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.15);
        background: white;
    }

    .form-label {
        font-weight: 500;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .btn {
        border-radius: var(--border-radius);
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: var(--transition);
        font-size: 0.95rem;
        border: 1px solid transparent;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
    }

    .btn-outline-secondary {
        border-color: var(--border-color);
        color: var(--secondary-color);
        background: white;
    }

    .btn-outline-secondary:hover {
        background-color: var(--light-bg);
        border-color: var(--secondary-color);
        color: var(--secondary-color);
        transform: translateY(-1px);
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .badge {
        background-color: var(--primary-color);
        border-radius: 20px;
        padding: 0.4rem 0.8rem;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .alert {
        border-radius: var(--border-radius);
        border: none;
        padding: 1rem 1.25rem;
    }

    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid var(--warning-color);
    }

    .alert-link {
        color: var(--primary-color);
        font-weight: 600;
    }

    .pagination {
        margin: 0;
        padding: 0.5rem 0;
    }

    .page-link {
        border: 1px solid var(--border-color);
        color: var(--primary-color);
        padding: 0.5rem 0.75rem;
        margin: 0 2px;
        border-radius: var(--border-radius);
        transition: var(--transition);
        background: white;
    }

    .page-link:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .page-item.disabled .page-link {
        color: var(--text-muted);
        background-color: white;
        border-color: var(--border-color);
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        color: var(--primary-color);
    }

    #loadingSpinner {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--card-shadow);
    }

    .form-text {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    /* Subtle animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card {
        animation: fadeInUp 0.5s ease-out;
    }

    .card:nth-child(2) { animation-delay: 0.1s; }
    .card:nth-child(3) { animation-delay: 0.2s; }

    /* Icon styles */
    .fas {
        width: 16px;
        text-align: center;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-body {
            padding: 1.25rem;
        }
        
        .search-section {
            padding: 1.25rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
        }
    }

    /* Focus styles for accessibility */
    .btn:focus,
    .form-control:focus,
    .page-link:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }
</style>

<!-- Integrated Search -->
<div class="col-lg-8">
    <div class="search-section">
        <h6 class="mb-2"><i class="fas fa-search"></i> Quick Tenant Lookup</h6>
        <form action="{{ url_for('manage_tenants') }}" method="GET" class="d-flex">
            <input class="form-control me-2" type="search" placeholder="Search tenant for reading..." name="search" value="{{ search_query }}">
            <button class="btn btn-primary btn-sm" type="submit">
                <i class="fas fa-search"> Search </i>
            </button>
            {% if search_query %}
                <a href="{{ url_for('manage_tenants') }}" class="btn btn-outline-secondary btn-sm ms-1">
                    <i class="fas fa-times"> Cancel</i>
                </a>
            {% endif %}
            <input type="hidden" name="search_type" value="all">
        </form>
    </div>
</div>
<div class="row mb-4">
      <div class="col-md-6">
        <!-- Add Tenant Form -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-person-plus"></i> Add New Tenant</h5>
            {% if tenant_count >= (max_tenants * 0.8) and max_tenants != -1 %}
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                  <strong>Approaching Limit!</strong> You are using {{ tenant_count }} of {{ max_tenants }} tenants in your {{ subscription_tier_name }} plan.
                  <a href="{{ url_for('subscription') }}" class="alert-link">Upgrade now</a> to add more tenants.
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endif %}
          </div>
          <div class="card-body">
            <form action="{{ url_for('add_tenant') }}" method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" name="name" required>
              </div>
              <div class="mb-3">
                <label for="house_number" class="form-label">House Number</label>
                <input type="text" class="form-control" id="house_number" name="house_number" required>
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="text" class="form-control" id="phone" name="phone" placeholder="+254..." required>
              </div>
              <button type="submit" class="btn btn-primary">Add Tenant</button>
            </form>
          </div>
        </div>

                      <!-- Import Tenants from Excel -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-file-earmark-excel"></i> Import Tenants from Excel</h5>
          </div>
          <div class="card-body">
            <form id="importForm" action="{{ url_for('import_tenants') }}" method="post" enctype="multipart/form-data">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="mb-3">
                <label for="excel_file" class="form-label">Excel File</label>
                <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx, .xls" required>
                <div class="form-text">Upload Excel file with tenant data</div>
              </div>
              <button type="submit" class="btn btn-primary">Import Tenants</button>
            </form>
            
            <!-- Spinner (hidden by default) -->
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Uploading...</span>
              </div>
              <p class="mt-2">Processing your file, please wait...</p>
            </div>
            
            <!-- Excel Format Preview -->
            <div class="mt-3">
              <h6>Expected Excel Format:</h6>
              <div class="excel-preview">
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th>name</th>
                      <th>house</th>
                      <th>phone</th>
                      <th>last_reading</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>John</td>
                      <td>A1</td>
                      <td>07**</td>
                      <td>100.5</td>
                    </tr>
                    <tr>
                      <td>Jane</td>
                      <td>B2</td>
                      <td>072***</td>
                      <td>85.2</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-2">
                <a href="{{ url_for('download_tenant_template') }}" class="btn btn-outline-secondary btn-sm">
                  Download Template
                </a>
              </div>
            </div>
          </div>
        </div>


      </div>

      <div class="col-md-6">
  

        <!-- Tenants List -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-people"></i> Tenants</h5>
            <span class="badge bg-light text-dark">{{ tenants|length }} Total</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>House #</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody>
                  {% for tenant in tenants %}
                    <tr>
                      <td><a href="{{ url_for('tenant_details', tenant_id=tenant.id) }}" class="tenant-link">{{ tenant.name }}</a></td>
                      <td>{{ tenant.house_number }}</td>
                      <td>{{ tenant.phone }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Pagination Controls -->
            <nav aria-label="Tenant pagination">
              <ul class="pagination justify-content-center mt-3">
                {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('manage_tenants', page=pagination.page-1, search=search_query) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% endif %}
                
                {% for page_num in range(1, pagination.pages + 1) %}
                  {% if page_num == pagination.page %}
                  <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                  </li>
                  {% else %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('manage_tenants', page=page_num, search=search_query) }}">{{ page_num }}</a>
                  </li>
                  {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('manage_tenants', page=pagination.page+1, search=search_query) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>


      </div>
    </div>

{% endblock %}