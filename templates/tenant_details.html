{% extends 'base.html' %}

{% block title %}{{ tenant.name }} - Billing History{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ tenant.name }}'s Billing History</h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">Back to Dashboard</a>
  </div>
  
  <div class="card mb-4">
    <div class="card-header">
      <h5>Customer Information</h5>
    </div>
    <div class="card-body">
      <p><strong>Name:</strong> {{ tenant.name }}</p>
      <p><strong>Phone:</strong> {{ tenant.phone }}</p>
      <p><strong>Total Readings:</strong> {{ readings|length }}</p>
      {% if readings and readings|length > 0 %}
        {% set latest_reading = readings[0] if readings[0].date_recorded > readings[-1].date_recorded else readings[-1] %}
        <p><strong>Latest Bill:</strong> Ksh {{ latest_reading.bill_amount }}</p>
      {% endif %}
    </div>
  </div>
  
  <!-- Billing History Chart -->
  <div class="card mb-4">
    <div class="card-header">
      <h5>Billing History Chart</h5>
    </div>
    <div class="card-body">
      <!-- Add a fixed height container to prevent collapsing on hover -->
      <div style="height: 400px; position: relative;">
        <canvas id="billingChart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Billing History Table -->
  <div class="card">
    <div class="card-header">
      <h5>Billing History Details</h5>
    </div>
    <div class="card-body">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Previous Reading</th>
            <th>Current Reading</th>
            <th>Usage (m³)</th>
            <th>Bill Amount (Ksh)</th>
          </tr>
        </thead>
        <tbody>
          {% for reading in readings|sort(attribute='date_recorded', reverse=true) %}
          <tr>
            <td>{{ reading.date_recorded.strftime('%Y-%m-%d') }}</td>
            <td>{{ reading.previous_reading }} m³</td>
            <td>{{ reading.current_reading }} m³</td>
            <td>{{ reading.usage }} m³</td>
            <td>Ksh {{ reading.bill_amount }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Safely parse JSON data from Flask
    let labels = [];
    let usageData = [];
    
    try {
      labels = {{ labels|tojson }};
      usageData = {{ usage_data|tojson }};
      
      console.log('Labels:', labels);
      console.log('Usage Data:', usageData);
    } catch (e) {
      console.error('Error parsing chart data:', e);
    }
    
    // Ensure we have valid arrays
    if (!Array.isArray(labels)) labels = [];
    if (!Array.isArray(usageData)) usageData = [];
    
    // If no data is provided, use some dummy data for visualization
    if (labels.length === 0) {
      console.warn("No chart data provided. Using fallback dummy data.");
      labels = ["2025-01-01", "2025-02-01", "2025-03-01"];
      usageData = [50, 75, 60];
    }
    
    // Handle duplicate dates by adding time information
    const uniqueLabels = [];
    const uniqueUsageData = [];
    
    // Process data to handle duplicates
    for (let i = 0; i < labels.length; i++) {
      let label = labels[i];
      // If this date already exists, add a suffix
      let count = 0;
      for (let j = 0; j < i; j++) {
        if (labels[j] === label) count++;
      }
      if (count > 0) {
        label = `${label} (${count + 1})`;
      }
      uniqueLabels.push(label);
      uniqueUsageData.push(usageData[i]);
    }
    
    const ctx = document.getElementById('billingChart').getContext('2d');
    const billingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: uniqueLabels,
        datasets: [
          {
            label: 'Water Usage (m³)',
            data: uniqueUsageData,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,  // Change to false to respect container dimensions
        plugins: {
          title: {
            display: true,
            text: 'Water Usage Trend',
            font: {
              size: 16
            }
          },
          legend: {
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Water Usage (m³)',
              font: {
                weight: 'bold'
              }
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            title: {
              display: true,
              text: 'Date',
              font: {
                weight: 'bold'
              }
            }
          }
        }
      }
    });
  });
</script>
{% endblock %}