{% extends 'base.html' %}

{% block title %}{{ tenant.name }} - Billing History{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ tenant.name }}'s Billing History</h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">Back to Dashboard</a>
  </div>
  
  <div class="card mb-4">
    <div class="card-header">
      <h5>Customer Information</h5>
    </div>
    <div class="card-body">
      <p><strong>Name:</strong> {{ tenant.name }}</p>
      <p><strong>Phone:</strong> {{ tenant.phone }}</p>
      <p><strong>Total Readings:</strong> {{ readings|length }}</p>
      {% if readings and readings|length > 0 %}
        {% set latest_reading = readings[0] if readings[0].date_recorded > readings[-1].date_recorded else readings[-1] %}
        <p><strong>Latest Bill:</strong> Ksh {{ latest_reading.bill_amount }}</p>
      {% endif %}
    </div>
  </div>
  
  <!-- Billing History Chart -->
  <div class="card mb-4">
    <div class="card-header">
      <h5>Billing History Chart</h5>
    </div>
    <div class="card-body">
      <canvas id="billingChart" height="300"></canvas>
    </div>
  </div>
  
  <!-- Billing History Table -->
  <div class="card">
    <div class="card-header">
      <h5>Billing History Details</h5>
    </div>
    <div class="card-body">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th>Previous Reading</th>
            <th>Current Reading</th>
            <th>Usage (m³)</th>
            <th>Bill Amount (Ksh)</th>
          </tr>
        </thead>
        <tbody>
          {% for reading in readings|sort(attribute='date_recorded', reverse=true) %}
          <tr>
            <td>{{ reading.date_recorded.strftime('%Y-%m-%d') }}</td>
            <td>{{ reading.previous_reading }} m³</td>
            <td>{{ reading.current_reading }} m³</td>
            <td>{{ reading.usage }} m³</td>
            <td>Ksh {{ reading.bill_amount }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Safely parse JSON data from Flask
    let labels = [];
    let usageData = [];
    let billData = [];
    
    try {
      labels = {{ labels|tojson }};
      usageData = {{ usage_data|tojson }};
      billData = {{ bill_data|tojson }};
      
      console.log('Labels:', labels);
      console.log('Usage Data:', usageData);
      console.log('Bill Data:', billData);
    } catch (e) {
      console.error('Error parsing chart data:', e);
    }
    
    // Ensure we have valid arrays
    if (!Array.isArray(labels)) labels = [];
    if (!Array.isArray(usageData)) usageData = [];
    if (!Array.isArray(billData)) billData = [];
    
    // If no data is provided, use some dummy data for visualization
    if (labels.length === 0) {
      console.warn("No chart data provided. Using fallback dummy data.");
      labels = ["2025-01-01", "2025-02-01", "2025-03-01"];
      usageData = [50, 75, 60];
      billData = [500, 750, 600];
    }
    
    const ctx = document.getElementById('billingChart').getContext('2d');
    const billingChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Water Usage (m³)',
            data: usageData,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            yAxisID: 'y',
            tension: 0.4
          },
          {
            label: 'Bill Amount (Ksh)',
            data: billData,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            yAxisID: 'y1',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            title: {
              display: true,
              text: 'Water Usage (m³)'
            }
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: {
              drawOnChartArea: false
            },
            title: {
              display: true,
              text: 'Bill Amount (Ksh)'
            }
          }
        }
      }
    });
  });
</script>
{% endblock %}