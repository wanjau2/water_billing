<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Water Billing Dashboard</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='images.jpeg') }}" type="image/jpeg">
  <style>
    .tenant-link {
      color: #0d6efd;
      text-decoration: none;
      cursor: pointer;
    }
    .tenant-link:hover {
      text-decoration: underline;
    }
    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 1.5rem;
      border: none;
      border-radius: 10px;
    }
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom: none;
      border-radius: 10px 10px 0 0 !important;
    }
    .table-responsive {
      overflow-x: auto;
    }
    .excel-preview {
      border: 1px solid #dee2e6;
      padding: 10px;
      background-color: #f8f9fa;
      margin-top: 10px;
      border-radius: 4px;
    }
    .excel-preview table {
      width: 100%;
      margin-bottom: 0;
    }
    .excel-preview th {
      background-color: #e9ecef;
    }
    .sticky-analytics {
      position: sticky;
      top: 0;
      z-index: 1020;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      padding: 1rem 0;
      margin-bottom: 2rem;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .stats-number {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.2rem;
    }
    .stats-label {
      font-size: 0.75rem;
      opacity: 0.9;
    }
    .search-section {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .chart-container {
      position: relative;
      height: 250px;
      margin: 1rem 0;
    }
    .metric-card {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }
    .metric-card:hover {
      transform: translateY(-2px);
    }
    .refresh-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      transition: all 0.3s;
    }
    .refresh-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
  </style>
  <!-- Move the inline script to an external file -->
  <script src="{{ url_for('static', filename='js/auto-fill.js') }}" defer></script>
  <link rel="stylesheet" href="{{url_for('static',filename='dist/output.css')}}">
</head>
<body>
  <style>
    @plugin "flowbite/plugin";
    @source "../../node_modules/flowbite";
  </style>
  <!-- Navigation Bar -->

<button data-drawer-target="logo-sidebar" data-drawer-toggle="logo-sidebar" aria-controls="logo-sidebar" type="button" class="inline-flex items-center p-2 mt-2 ms-3 text-sm text-gray-500 rounded-lg sm:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
   <span class="sr-only">Open sidebar</span>
   <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
   <path clip-rule="evenodd" fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z"></path>
   </svg>
</button>

<aside id="logo-sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0" aria-label="Sidebar">
   <div class="h-full px-3 py-4 overflow-y-auto bg-gray-50 dark:bg-gray-800">
      <a href="https://flowbite.com/" class="flex items-center ps-2.5 mb-5">
         <img src="https://flowbite.com/docs/images/logo.svg" class="h-6 me-3 sm:h-7" alt="Flowbite Logo" />
         <span class="self-center text-xl font-semibold whitespace-nowrap dark:text-white">Flowbite</span>
      </a>
      <ul class="space-y-2 font-medium">
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 21">
                  <path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998 8.5 8.5 0 1 0 9.039 9.039.999.999 0 0 0-1-1.066h.002Z"/>
                  <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0Z"/>
               </svg>
               <span class="ms-3">Dashboard</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 18">
                  <path d="M6.143 0H1.857A1.857 1.857 0 0 0 0 1.857v4.286C0 7.169.831 8 1.857 8h4.286A1.857 1.857 0 0 0 8 6.143V1.857A1.857 1.857 0 0 0 6.143 0Zm10 0h-4.286A1.857 1.857 0 0 0 10 1.857v4.286C10 7.169 10.831 8 11.857 8h4.286A1.857 1.857 0 0 0 18 6.143V1.857A1.857 1.857 0 0 0 16.143 0Zm-10 10H1.857A1.857 1.857 0 0 0 0 11.857v4.286C0 17.169.831 18 1.857 18h4.286A1.857 1.857 0 0 0 8 16.143v-4.286A1.857 1.857 0 0 0 6.143 10Zm10 0h-4.286A1.857 1.857 0 0 0 10 11.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 18 16.143v-4.286A1.857 1.857 0 0 0 16.143 10Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Kanban</span>
               <span class="inline-flex items-center justify-center px-2 ms-3 text-sm font-medium text-gray-800 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-300">Pro</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                  <path d="m17.418 3.623-.018-.008a6.713 6.713 0 0 0-2.4-.569V2h1a1 1 0 1 0 0-2h-2a1 1 0 0 0-1 1v2H9.89A6.977 6.977 0 0 1 12 8v5h-2V8A5 5 0 1 0 0 8v6a1 1 0 0 0 1 1h8v4a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-4h6a1 1 0 0 0 1-1V8a5 5 0 0 0-2.582-4.377ZM6 12H4a1 1 0 0 1 0-2h2a1 1 0 0 1 0 2Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Inbox</span>
               <span class="inline-flex items-center justify-center w-3 h-3 p-3 ms-3 text-sm font-medium text-blue-800 bg-blue-100 rounded-full dark:bg-blue-900 dark:text-blue-300">3</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 18">
                  <path d="M14 2a3.963 3.963 0 0 0-1.4.267 6.439 6.439 0 0 1-1.331 6.638A4 4 0 1 0 14 2Zm1 9h-1.264A6.957 6.957 0 0 1 15 15v2a2.97 2.97 0 0 1-.184 1H19a1 1 0 0 0 1-1v-1a5.006 5.006 0 0 0-5-5ZM6.5 9a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9ZM8 10H5a5.006 5.006 0 0 0-5 5v2a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-2a5.006 5.006 0 0 0-5-5Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Users</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                  <path d="M17 5.923A1 1 0 0 0 16 5h-3V4a4 4 0 1 0-8 0v1H2a1 1 0 0 0-1 .923L.086 17.846A2 2 0 0 0 2.08 20h13.84a2 2 0 0 0 1.994-2.153L17 5.923ZM7 9a1 1 0 0 1-2 0V7h2v2Zm0-5a2 2 0 1 1 4 0v1H7V4Zm6 5a1 1 0 1 1-2 0V7h2v2Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Products</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 16">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 8h11m0 0L8 4m4 4-4 4m4-11h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-3"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Sign In</span>
            </a>
         </li>
         <li>
            <a href="#" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
               <svg class="shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M5 5V.13a2.96 2.96 0 0 0-1.293.749L.879 3.707A2.96 2.96 0 0 0 .13 5H5Z"/>
                  <path d="M6.737 11.061a2.961 2.961 0 0 1 .81-1.515l6.117-6.116A4.839 4.839 0 0 1 16 2.141V2a1.97 1.97 0 0 0-1.933-2H7v5a2 2 0 0 1-2 2H0v11a1.969 1.969 0 0 0 1.933 2h12.134A1.97 1.97 0 0 0 16 18v-3.093l-1.546 1.546c-.413.413-.94.695-1.513.81l-3.4.679a2.947 2.947 0 0 1-1.85-.227 2.96 2.96 0 0 1-1.635-3.257l.681-3.397Z"/>
                  <path d="M8.961 16a.93.93 0 0 0 .189-.019l3.4-.679a.961.961 0 0 0 .49-.263l6.118-6.117a2.884 2.884 0 0 0-4.079-4.078l-6.117 6.117a.96.96 0 0 0-.263.491l-.679 3.4A.961.961 0 0 0 8.961 16Zm7.477-9.8a.958.958 0 0 1 .68-.281.961.961 0 0 1 .682 1.644l-.315.315-1.36-1.36.313-.318Zm-5.911 5.911 4.236-4.236 1.359 1.359-4.236 4.237-1.7.339.341-1.699Z"/>
               </svg>
               <span class="flex-1 ms-3 whitespace-nowrap">Sign Up</span>
            </a>
         </li>
      </ul>
   </div>
</aside>

<div class="p-4 sm:ml-64">
   <div class="p-4 border-2 border-gray-200 border-dashed rounded-lg dark:border-gray-700">
      <div class="grid grid-cols-3 gap-4 mb-4">
         <div class="flex items-center justify-center h-24 rounded-sm bg-gray-50 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center h-24 rounded-sm bg-gray-50 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center h-24 rounded-sm bg-gray-50 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
      </div>
      <div class="flex items-center justify-center h-48 mb-4 rounded-sm bg-gray-50 dark:bg-gray-800">
         <p class="text-2xl text-gray-400 dark:text-gray-500">
            <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
               <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
            </svg>
         </p>
      </div>
      <div class="grid grid-cols-2 gap-4 mb-4">
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
      </div>
      <div class="flex items-center justify-center h-48 mb-4 rounded-sm bg-gray-50 dark:bg-gray-800">
         <p class="text-2xl text-gray-400 dark:text-gray-500">
            <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
               <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
            </svg>
         </p>
      </div>
      <div class="grid grid-cols-2 gap-4">
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
         <div class="flex items-center justify-center rounded-sm bg-gray-50 h-28 dark:bg-gray-800">
            <p class="text-2xl text-gray-400 dark:text-gray-500">
               <svg class="w-3.5 h-3.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
               </svg>
            </p>
         </div>
      </div>
   </div>
</div>
>

  <div class="container mt-4">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for message_data in messages %}
        <div class="alert alert-{{ message_data[0] if message_data is iterable and message_data|length > 1 else 'info' }} alert-dismissible fade show" role="alert">
          {{ message_data[1] if message_data is iterable and message_data|length > 1 else message_data }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Sticky Analytics Overview with Integrated Search -->
    <div class="sticky-analytics">
      <div class="container">
        <div class="row">
          <!-- Compact Analytics Cards -->
          <div class="col-lg-12">
            <div class="row">
              <div class="col-lg-3 col-md-6 mb-2">
                <div class="stats-card">
                  <div class="stats-number" id="total-tenants">{{ tenants|length }}</div>
                  <div class="stats-label">Total Tenants</div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 mb-2">
                <div class="stats-card">
                  <div class="stats-number" id="monthly-consumption">{{ "%.1f"|format(monthly_consumption or 0) }}</div>
                  <div class="stats-label">Monthly Consumption (m³)</div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 mb-2">
                <div class="stats-card">
                  <div class="stats-number" id="total-revenue">{{ "%.1f"|format(total_revenue or 0) }}</div>
                  <div class="stats-label">Combined Revenue (KES)</div>
                </div>
              </div>
              <div class="col-lg-3 col-md-6 mb-2">
                <div class="stats-card">
                  <div class="stats-number" id="avg-usage">{{ "%.1f"|format(avg_usage or 0) }}</div>
                  <div class="stats-label">Avg Usage per Tenant (m³)</div>
                </div>
              </div>
            </div>
          </div>


        </div>
                  <!-- Integrated Search -->
          <div class="col-lg-8">
            <div class="search-section">
              <h6 class="mb-2"><i class="fas fa-search"></i> Quick Tenant Lookup</h6>
              <form action="{{ url_for('dashboard') }}" method="GET" class="d-flex">
                <input class="form-control me-4" type="search" placeholder="Search tenant for reading..." name="search" value="{{ search_query }}">
                <button class="btn btn-primary btn-sm" type="submit">
                  <i class="fas fa-search">Search </i>
                </button>
                {% if search_query %}
                  <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm ms-1">
                    <i class="fas fa-times"> Cancel</i>
                  </a>
                {% endif %}
                <input type="hidden" name="search_type" value="all">
              </form>

            </div>
          </div>
      </div>
    </div>

    <!-- Action Center -->
    <div class="row mb-4">
      <div class="col-md-6">
        <!-- Add Tenant Form -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-user-plus"></i> Add New Tenant</h5>
            {% if tenant_count >= (max_tenants * 0.8) and max_tenants != -1 %}
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                  <strong>Approaching Limit!</strong> You are using {{ tenant_count }} of {{ max_tenants }} tenants in your {{ subscription_tier_name }} plan.
                  <a href="{{ url_for('subscription') }}" class="alert-link">Upgrade now</a> to add more tenants.
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endif %}
          </div>
          <div class="card-body">
            <form action="{{ url_for('add_tenant') }}" method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" name="name" required>
              </div>
              <div class="mb-3">
                <label for="house_number" class="form-label">House Number</label>
                <input type="text" class="form-control" id="house_number" name="house_number" required>
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="text" class="form-control" id="phone" name="phone" placeholder="+254..." required>
              </div>
              <button type="submit" class="btn btn-primary">Add Tenant</button>
            </form>
          </div>
        </div>

        <!-- Import Tenants from Excel -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-file-excel"></i> Import Tenants from Excel</h5>
          </div>
          <div class="card-body">
            <form id="importForm" action="{{ url_for('import_tenants') }}" method="post" enctype="multipart/form-data">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="mb-3">
                <label for="excel_file" class="form-label">Excel File</label>
                <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx, .xls" required>
                <div class="form-text">Upload Excel file with tenant data</div>
              </div>
              <button type="submit" class="btn btn-primary">Import Tenants</button>
            </form>

            <!-- Spinner (hidden by default) -->
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Uploading...</span>
              </div>
              <p class="mt-2">Processing your file, please wait...</p>
            </div>


            <!-- Excel Format Preview -->
            <div class="mt-3">
              <h6>Expected Excel Format:</h6>
              <div class="excel-preview">
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th>name</th>
                      <th>house</th>
                      <th>phone</th>
                      <th>last_reading</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>John</td>
                      <td>A1</td>
                      <td>07**</td>
                      <td>100.5</td>
                    </tr>
                    <tr>
                      <td>Jane</td>
                      <td>B2</td>
                      <td>072***</td>
                      <td>85.2</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-2">
                <a href="{{ url_for('download_tenant_template') }}" class="btn btn-outline-secondary btn-sm">
                  Download Template
                </a>
              </div>
            </div>

            <script>
                document.getElementById("importForm").addEventListener("submit", function () {
                  document.getElementById("loadingSpinner").style.display = "block";
                });
            </script>
          </div>
        </div>


      </div>

      <div class="col-md-6">
                        <!-- Bulk Readings Import -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-file-import"></i> Bulk Readings Import</h5>
          </div>
          <div class="card-body">
            <ul class="nav nav-tabs" id="bulkReadingTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel-import" type="button" role="tab">Excel File</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-import" type="button" role="tab">Text File</button>
              </li>
            </ul>

            <div class="tab-content mt-3" id="bulkReadingContent">
              <!-- Excel Import Tab -->
              <div class="tab-pane fade show active" id="excel-import" role="tabpanel">
                <form id="bulkReadingsExcelForm" action="{{ url_for('bulk_import_readings_excel') }}" method="post" enctype="multipart/form-data">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="mb-3">
                    <label for="readings_excel_file" class="form-label">Excel File</label>
                    <input type="file" class="form-control" id="readings_excel_file" name="readings_excel_file" accept=".xlsx, .xls" required>
                    <div class="form-text">Upload Excel file with house numbers and readings</div>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="send_sms_excel" name="send_sms" value="true" checked>
                    <label class="form-check-label" for="send_sms_excel">
                      <i class="fas fa-sms"></i> Send SMS notifications to tenants
                    </label>
                    <div class="form-text">Uncheck to import readings without sending SMS alerts</div>
                  </div>
                  <button type="submit" class="btn btn-success">Import Readings</button>
                </form>

                <!-- Excel Format Preview -->
                <div class="mt-3">
                  <h6>Expected Excel Format:</h6>
                  <div class="excel-preview">
                    <table class="table table-sm table-bordered">
                      <thead>
                        <tr>
                          <th>house_number</th>
                          <th>current_reading</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>A08</td>
                          <td>30</td>
                        </tr>
                        <tr>
                          <td>B12</td>
                          <td>45.5</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="mt-2">
                    <a href="{{ url_for('download_bulk_readings_template') }}" class="btn btn-outline-secondary btn-sm">
                      Download Template
                    </a>
                  </div>
                </div>
              </div>

              <!-- Text Import Tab -->
              <div class="tab-pane fade" id="text-import" role="tabpanel">
                <form id="bulkReadingsTextForm" action="{{ url_for('bulk_import_readings_text') }}" method="post" enctype="multipart/form-data">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="mb-3">
                    <label for="readings_text_file" class="form-label">Text File</label>
                    <input type="file" class="form-control" id="readings_text_file" name="readings_text_file" accept=".txt" required>
                    <div class="form-text">Upload text file with readings (one per line)</div>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="send_sms_text" name="send_sms" value="true" checked>
                    <label class="form-check-label" for="send_sms_text">
                      <i class="fas fa-sms"></i> Send SMS notifications to tenants
                    </label>
                    <div class="form-text">Uncheck to import readings without sending SMS alerts</div>
                  </div>
                  <button type="submit" class="btn btn-success">Import Readings</button>
                </form>

                <!-- Text Format Preview -->
                <div class="mt-3">
                  <h6>Expected Text Format (one reading per line):</h6>
                  <div class="excel-preview">
                    <pre class="mb-0">A08 30
B12 45.5
C05 25
D14 38</pre>
                  </div>
                  <small class="text-muted">Format: [house_number] [space] [reading]</small>
                </div>
              </div>
            </div>

            <!-- Spinner (hidden by default) -->
            <div id="bulkReadingsSpinner" class="text-center mt-3" style="display: none;">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Processing...</span>
              </div>
              <p class="mt-2">Processing bulk readings, please wait...</p>
            </div>
          </div>
        </div>
        <!-- Tenants List -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users"></i> Tenants</h5>
            <span class="badge bg-light text-dark">{{ tenants|length }} Total</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>House #</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody>
                  {% for tenant in tenants %}
                    <tr>
                      <td><a href="{{ url_for('tenant_details', tenant_id=tenant.id) }}" class="tenant-link">{{ tenant.name }}</a></td>
                      <td>{{ tenant.house_number }}</td>
                      <td>{{ tenant.phone }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Pagination Controls -->
            <nav aria-label="Tenant pagination">
              <ul class="pagination justify-content-center mt-3">
                {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('dashboard', page=pagination.page-1, search=search_query) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% endif %}

                {% for page_num in range(1, pagination.pages + 1) %}
                  {% if page_num == pagination.page %}
                  <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                  </li>
                  {% else %}
                  <li class="page-item">
                    <a class="page-link" href="{{ url_for('dashboard', page=page_num, search=search_query) }}">{{ page_num }}</a>
                  </li>
                  {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('dashboard', page=pagination.page+1, search=search_query) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>

      </div>
    </div>


    <!-- Analytics Dashboard -->
    <div class="row mb-4">
      <div class="col-12">
        <h3><i class="fas fa-chart-bar"></i> Analytics Dashboard</h3>
      </div>
    </div>

    <!-- Enhanced Charts Section -->
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Monthly Consumption Trends</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="consumptionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Revenue Trends</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Top Consumers</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="topConsumersChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Usage Distribution</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="usageDistributionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Options -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Export Options</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <a href="{{ url_for('export_data') }}" class="btn btn-outline-primary w-100 mb-2">
                  <i class="fas fa-download"></i> Download All Data
                </a>
              </div>
              <div class="col-md-4">
                <button class="btn btn-outline-success w-100 mb-2" onclick="exportChart('consumptionChart', 'consumption-trends')">
                  <i class="fas fa-chart-bar"></i> Export Charts
                </button>
              </div>
              <div class="col-md-4">
                <button class="btn btn-outline-info w-100 mb-2" onclick="generateReport()">
                  <i class="fas fa-file-pdf"></i> Generate Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  <script>
    let charts = {};

    document.addEventListener('DOMContentLoaded', function() {
      initializeCharts();
      setupRefreshButton();
    });

    function initializeCharts() {
      // Consumption Chart
      const consumptionCtx = document.getElementById('consumptionChart').getContext('2d');

      // Process data for consumption chart
      const monthlyData = {};
      const monthlyRevenue = {};
      let readingDate, monthYear;

      {% for reading, tenant in readings %}
        readingDate = new Date('{{ reading.date_recorded.strftime("%Y-%m-%d") }}');
        monthYear = readingDate.toLocaleString('default', { month: 'short', year: 'numeric' });

        if (!monthlyData[monthYear]) {
          monthlyData[monthYear] = 0;
          monthlyRevenue[monthYear] = 0;
        }
        monthlyData[monthYear] += {{ reading.usage }};
        monthlyRevenue[monthYear] += {{ reading.bill_amount }};
      {% endfor %}

      const months = Object.keys(monthlyData).sort((a, b) => {
        const dateA = new Date(a);
        const dateB = new Date(b);
        return dateA - dateB;
      });

      const monthlyUsage = months.map(month => monthlyData[month]);
      const monthlyRevenueData = months.map(month => monthlyRevenue[month]);

      // Consumption Chart
      charts.consumption = new Chart(consumptionCtx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Water Consumption (m³)',
            data: monthlyUsage,
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              title: {
                display: true,
                text: 'Consumption (m³)'
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });

      // Revenue Chart
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      charts.revenue = new Chart(revenueCtx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Monthly Revenue (KES)',
            data: monthlyRevenueData,
            backgroundColor: 'rgba(40, 167, 69, 0.8)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              },
              title: {
                display: true,
                text: 'Revenue (KES)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });

      // Top Consumers Chart
      const topConsumersCtx = document.getElementById('topConsumersChart').getContext('2d');
      const tenantUsage = {};

      {% for reading, tenant in readings %}
        if (!tenantUsage['{{ tenant.name }}']) {
          tenantUsage['{{ tenant.name }}'] = 0;
        }
        tenantUsage['{{ tenant.name }}'] += {{ reading.usage }};
      {% endfor %}

      const sortedTenants = Object.entries(tenantUsage)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);

      charts.topConsumers = new Chart(topConsumersCtx, {
        type: 'doughnut',
        data: {
          labels: sortedTenants.map(([name]) => name),
          datasets: [{
            data: sortedTenants.map(([, usage]) => usage),
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
              '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
              '#4BC0C0', '#FF6384'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            }
          }
        }
      });

      // Usage Distribution Chart
      const usageDistCtx = document.getElementById('usageDistributionChart').getContext('2d');
      const usageRanges = {
        '0-10 m³': 0,
        '11-20 m³': 0,
        '21-30 m³': 0,
        '31-50 m³': 0,
        '50+ m³': 0
      };

      {% for reading, tenant in readings %}
        (function() {
          const usage = {{ reading.usage }};
          if (usage <= 10) usageRanges['0-10 m³']++;
          else if (usage <= 20) usageRanges['11-20 m³']++;
          else if (usage <= 30) usageRanges['21-30 m³']++;
          else if (usage <= 50) usageRanges['31-50 m³']++;
          else usageRanges['50+ m³']++;
        })();
      {% endfor %}

      charts.usageDistribution = new Chart(usageDistCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(usageRanges),
          datasets: [{
            data: Object.values(usageRanges),
            backgroundColor: [
              'rgba(255, 99, 132, 0.8)',
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 205, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            }
          }
        }
      });
    }

    function setupRefreshButton() {
      document.getElementById('refresh-data').addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

        // Simulate data refresh
        setTimeout(() => {
          location.reload();
        }, 1000);
      });
    }

    function exportChart(chartId, filename) {
      const chart = charts[chartId.replace('Chart', '')];
      if (chart) {
        const url = chart.toBase64Image();
        const link = document.createElement('a');
        link.download = filename + '.png';
        link.href = url;
        link.click();
      }
    }

    function generateReport() {
      // This would trigger a backend endpoint to generate a comprehensive PDF report
      window.open('/generate_analytics_report', '_blank');
    }

    // Bulk readings import handling
    document.getElementById("bulkReadingsExcelForm").addEventListener("submit", function () {
      document.getElementById("bulkReadingsSpinner").style.display = "block";
    });

    document.getElementById("bulkReadingsTextForm").addEventListener("submit", function () {
      document.getElementById("bulkReadingsSpinner").style.display = "block";
    });
  </script>
</body>
</html>
